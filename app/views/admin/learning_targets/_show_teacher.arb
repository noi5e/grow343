@q = Student.ransack(params[:q])
@q.student_detail_teacher_id_eq = current_user.id if @q.student_detail_teacher_id_eq.nil? && params[:commit].blank?
@students = @q.result.grade(resource.grade).reorder(:last_name)
@student_ids = @students.pluck(:id)
@all_results = LearningResult.where(learning_target: learning_target)
@results = @all_results.select{ |result| result.student_id.in?(@student_ids) }

tabs do
  tab 'Details' do
    columns do
      column do
        render "student_filters", q: @q

        grouped_results = @results.group_by(&:student_id)
        score1s = {}
        table_for @students + [Student.new(email: 'dummy')] do
          column :name do |student|
            if student.email != 'dummy'
              div{link_to student.last_first, [:log_in, :admin, student], method: :post}
            end
          end
          (1..3).each do |version|
            column "V#{version}" do |student|
              if student.email == 'dummy'
                div{link_to 'Edit', [:edit_results, :admin, resource, version: version], class: :button}
                next
              end
              score = (grouped_results[student.id] || []).detect{ |result| result.version == version }.try(:score)
              if score
                score1s[student.id] = score if version == 1
                score1 = score1s[student.id]
                status = if version == 1 || score1.nil?
                  if score > 3
                    :ok
                  elsif score > 2
                    :warning
                  else
                    :error
                  end
                else
                  if score > score1 || score == 4
                    :ok
                  elsif score == score1
                    :warning
                  else
                    :error
                  end
                end
                status_tag score, status
              else
                text_node " - "
              end
            end
          end
          div do
            link_to('Download as CSV', "/reports/#{learning_target.id}.csv?learning_target_id=#{learning_target.id}&q%5Bstudent_detail_teacher_id_eq%5D=#{@q.student_detail_teacher_id_eq}")
          end
          div do
            link_to('Printer Friendly View', "/reports/#{learning_target.id}.html?learning_target_id=#{learning_target.id}&q%5Bstudent_detail_teacher_id_eq%5D=#{@q.student_detail_teacher_id_eq}", target: :_blank)
          end
        end

        attributes_table_for resource do
          resource.class.column_names.each do |key|
            row key
          end
        end
      end

      column do
        panel 'Whole Grade Results' do
          render 'graph', results: @all_results
        end
        panel 'Filtered Results' do
          render 'graph', results: @results
        end
      end
    end
  end
  (1..3).each do |version|
    tab "V#{version}" do
      panel "V#{version} Results" do
        div do
          link_to 'Update Results', [:edit_results, :admin, resource, version: version], class: :button
        end
        table_for @students do
          column :name
          column :score do |student|
            student.score(resource.learning_results, version)
          end
          column :objectives do |student|
            next if student.score(resource.learning_results, version).nil?
            resource.learning_objectives.each do |objective|
              div do
                span do
                  student.achievements.exists?(learning_objective_id: objective.id, learning_results: {version: version}) ? '✅' : '❌'
                end
                span { objective.name }
              end
            end
            nil
          end
          column :notes do |student|
            student.notes(resource.learning_results, version)
          end
        end
      end
    end
  end
end
