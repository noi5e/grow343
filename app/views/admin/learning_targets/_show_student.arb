results_query = current_user.learning_results.where(learning_target_id: resource.id)
results = results_query.group_by(&:learning_target_id)

versions = results[resource.id].map(&:version).sort

achievements = current_user.achievements
  .joins(:learning_result).where(learning_result_id: results_query.select(:id))
  .select('learning_results.version AS version, learning_objective_id')

script do
  raw(
  <<-JAVASCRIPT
    google.charts.setOnLoadCallback(function(){
      drawChart(#{results.values.flatten.map{|result| [%{V#{result.version}}, result.score] }.to_json}, 'chart-#{resource.id}');
    });
  JAVASCRIPT
  )
end

panel resource.title do
  columns do
    column span: 2 do
      table_for resource.learning_objectives + [LearningObjective.new(name: 'Comments:')] do
        column 'Learning Objective' do |objective|
          method = objective.name == 'Comments:' ? :strong : :span
          send(method) do
            objective.name
          end
        end
        3.times do |i|
          version = i + 1
          column "v#{version}" do |objective|
            if objective.name == 'Comments:'
              results[resource.id].detect{ |result| result.version == version }.try(&:notes)
            else
              if version > versions.max
                "-"
              else
                achievements.detect{ |achievement| achievement.learning_objective_id == objective.id && achievement.version.to_i == version }.present? ? '✅' : '❌'
              end
            end
          end
        end
        column 'LO Resource' do |objective|
          objective.learning_resources.select(&:instruction?).each do |instruction|
            li do
              link_to instruction.name, instruction.url
            end
          end
          nil
        end
        column 'LO Practice' do |objective|
          objective.learning_resources.select(&:practice?).each do |practice|
            li do
              link_to practice.name, practice.url
            end
          end
          nil
        end
      end
    end
    column do
      div(id: "chart-#{resource.id}", style:"height:200px;width:100%; margin-top:35px") do
        "hello world"
      end
    end
  end
end
